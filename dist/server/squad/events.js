"use strict";var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard"),_interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_logParser=require("../../log-parser"),_config=require("../../../config"),postLoginRule=_interopRequireWildcard(require("../../log-parser/rules/post-login")),_player=require("../../database/player"),_kill=require("../../database/kill"),Discord=require("discord.js"),Events=/*#__PURE__*/function(){function a(b){(0,_classCallCheck2["default"])(this,a),this.server=b,this.logChannel=this.server.client.channels.cache.find(function(a){return a.id===_config.serverLogChannelID})}return(0,_createClass2["default"])(a,[{key:"main",value:function main(){var a=this,b=new _logParser.LogParser(this.server);b.main(),this.server.on("TICK_RATE",function(b){a.tickRate(b)}),this.server.on("PLAYER_POSSESS",function(b){a.playerPossess(b)}),this.server.on("CLIENT_LOGIN",function(b,c){a.clientLogin(b,c)}),this.server.on("SERVER_UPDATE",function(){a.serverUpdate()}),this.server.on("PLAYER_DIED",function(b){a.playerDied(b)})}},{key:"tickRate",value:function tickRate(a){if(this.server.tickRate=a.tickRate,!(25<a.tickRate)){var b=new Discord.MessageEmbed().setTitle("Server Tick Rate Update").addFields({name:"Tick Rate",value:"".concat(a.tickRate)},{name:"Action Timestamp",value:"".concat(a.time)}).setTimestamp();25>=a.tickRate&&20<a.tickRate?b.setColor("#FFFF00"):20>=a.tickRate&&b.setColor("#ff0000"),this.logChannel.send(b)}}},{key:"playerPossess",value:function playerPossess(a){if("CameraMan"===a.classname){var b=new Discord.MessageEmbed().setColor("#0099ff").setTitle("Admin Cam Open").addFields({name:"Player Name",value:"".concat(a.player)},{name:"Action Timestamp",value:"".concat(a.time)}).setTimestamp();this.logChannel.send(b)}}},{key:"clientLogin",value:function clientLogin(a,b){if(_config.serverLogging){var c=b.split("\n"),d=c[0],e=d.match(postLoginRule["default"].regex);if(e){var f=postLoginRule["default"].parseArgs(e),g={name:a.name,steam64ID:a.steam64ID,playerController:f.playerController};(0,_player.fetchPlayers)().then(function(a){var b=a.find(function(a){return a.steam64ID===g.steam64ID});console.log(b),b?(0,_player.updatePlayer)(b._id,g):(0,_player.newPlayer)(g)})}}}},{key:"playerDied",value:function playerDied(a){var b=this;_config.serverLogging&&this.server.getPlayerByName(a.victim).then(function(c){b.server.getPlayerByController(a.attackerPlayerController).then(function(d){b.server.sameTeam(c.steam64ID,d[0].steam64ID).then(function(b){var e={victim:c.steam64ID,killer:d[0].steam64ID,weapon:a.weapon,teamkill:b};(0,_kill.newKill)(e)})})})}},{key:"serverUpdate",value:function serverUpdate(){setActivity(this.server),setMessage(this.server)}}]),a}();exports["default"]=Events;function setActivity(a){a.client.user.setActivity("(".concat(a.generatePlayersString(!0),") ").concat(a.map))}function setMessage(a){var b=a.client.channels.cache.find(function(a){return a.id===_config.seedingChannelID});b&&b.messages.fetch(_config.serverStatusMessageID).then(function(b){var c=b;c&&a.generateEmbed().then(function(a){c.edit(a)})})}