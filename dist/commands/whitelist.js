"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_config=require("../../config"),_functions=require("../functions"),fs=require("fs"),SteamAPI=require("web-api-steam"),got=require("got"),_default={name:"whitelist",description:"Adds the specified Steam 64 ID or the Steam 64 ID from the profile specified to the whitelist.",usage:"<steam64id or steam profile url>",args:!0,guildOnly:!1,aliases:["wl"],disabled:!1,execute:function execute(a,b){(0,_functions.log)("Entered ".concat(this.name," command file"));var c=b[0];a["delete"]({timeout:1e3}),validURL(c)?get64ID(b[0]).then(function(b){return b.response.steamid?void(c=b.response.steamid,addUser(c,a)):a.reply("specified Steam URL is invalid.").then(function(a){a["delete"]({timeout:5e3})})}):addUser(c,a)}};exports["default"]=_default;function validURL(a){// fragment locator
return!!/^(https?:\/\/)?((([a-z\d]([a-z\d-]*[a-z\d])*)\.)+[a-z]{2,}|((\d{1,3}\.){3}\d{1,3}))(\:\d+)?(\/[-a-z\d%_.~+]*)*(\?[;&a-z\d%_.~+=-]*)?(\#[-a-z\d_]*)?$/i.test(a)}function get64ID(){return _get64ID.apply(this,arguments)}function _get64ID(){return _get64ID=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(b){var c,d,e;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(c=b.split("/"),-1!==c.indexOf("id")&&(c=c[c.indexOf("id")+1]),-1===c.indexOf("profiles")){a.next=5;break}return d=c[c.indexOf("profiles")+1],a.abrupt("return",{response:{steamid:d}});case 5:return a.prev=5,a.next=8,got("http://api.steampowered.com/ISteamUser/ResolveVanityURL/v0001/?key=".concat(_config.steamAPIkey,"&vanityurl=").concat(c));case 8:return e=a.sent,a.abrupt("return",JSON.parse(e.body));case 12:a.prev=12,a.t0=a["catch"](5),console.log(a.t0.response.body);case 15:case"end":return a.stop();}},a,null,[[5,12]])})),_get64ID.apply(this,arguments)}function addUser(a,b){fs.readFile(_config.whitelistPath,"utf-8",function(c,d){return c?console.error(c):void SteamAPI.getPlayerInfo(a,_config.steamAPIkey,function(c,e){if(c)return c;if(!e)return b.reply("specified SteamID is invalid.").then(function(a){a["delete"]({timeout:5e3})});if(-1<d.indexOf(a))return b.reply("that user is already present in the whitelist.").then(function(a){a["delete"]({timeout:5e3})});var f="\r\nAdmin=".concat(a,":Whitelist // ").concat(e.personaname);fs.appendFile(_config.whitelistPath,f,function(a){return a?console.error(a):b.reply("successfully added Steam user ".concat(e.personaname," to the whitelist.")).then(function(a){a["delete"]({timeout:5e3})})})})})}